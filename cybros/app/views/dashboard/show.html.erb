<% content_for :action_bar do %>
  <div class="flex items-center gap-2">
    <span class="text-sm font-semibold">Dashboard</span>
  </div>
<% end %>

<div class="p-6 space-y-6" data-testid="dashboard-page">
  <div class="flex items-center justify-end gap-2">
    <%= form_with url: conversations_path, method: :post do %>
      <button type="submit" class="btn btn-primary btn-sm gap-2">
        <span class="icon-[lucide--plus] size-4"></span>
        New chat
      </button>
    <% end %>
    <%= link_to agent_programs_path, class: "btn btn-ghost btn-sm gap-2" do %>
      <span class="icon-[lucide--sparkles] size-4"></span>
      Agents
    <% end %>
  </div>

  <div class="stats stats-vertical lg:stats-horizontal shadow bg-base-100 border border-base-300">
    <div class="stat">
      <div class="stat-title">LLM providers</div>
      <div class="stat-value text-xl"><%= @provider_count %></div>
      <div class="stat-desc opacity-60">Configured providers</div>
    </div>
    <div class="stat">
      <div class="stat-title">Agent programs</div>
      <div class="stat-value text-xl"><%= @agent_program_count %></div>
      <div class="stat-desc opacity-60">Available agents</div>
    </div>
    <div class="stat">
      <div class="stat-title">Runs</div>
      <div class="stat-value text-xl"><%= @run_state_counts.values.sum %></div>
      <div class="stat-desc opacity-60">
        <%= @run_state_counts.fetch("running", 0) %> running Â· <%= @run_state_counts.fetch("failed", 0) %> failed
      </div>
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <div class="card bg-base-100 border border-base-300">
      <div class="card-body">
        <h2 class="card-title">Recent conversations</h2>

        <% if @recent_conversations.empty? %>
          <p class="opacity-70">No conversations yet.</p>
        <% else %>
          <ul class="list">
            <% @recent_conversations.each do |c| %>
              <li class="list-row">
                <div class="list-col-grow">
                  <div class="font-medium truncate"><%= c.title.presence || "(untitled)" %></div>
                  <div class="text-xs opacity-60"><%= c.created_at.to_fs(:short) %></div>
                </div>
                <div>
                  <%= link_to "Open", conversation_path(c), class: "btn btn-ghost btn-sm" %>
                </div>
              </li>
            <% end %>
          </ul>
        <% end %>
      </div>
    </div>

    <div class="card bg-base-100 border border-base-300">
      <div class="card-body">
        <h2 class="card-title">Last run</h2>

        <% if @last_run.nil? %>
          <p class="opacity-70">No runs yet.</p>
        <% else %>
          <div class="flex flex-wrap items-center gap-2">
            <span class="badge badge-outline"><%= @last_run.state %></span>
            <span class="text-sm opacity-70"><%= @last_run.created_at.to_fs(:short) %></span>
          </div>
          <div class="mt-3">
            <%= link_to "Open conversation", conversation_path(@last_run.conversation_id), class: "btn btn-ghost btn-sm" %>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

